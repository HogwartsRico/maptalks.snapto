/*!
 * maptalks.snapto v0.1.9
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@^0.33.1 
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function o(t,e){if(!(this instanceof o))return new o(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&this._initFormat(e),this.clear()}function r(t,e,o){if(!o)return e.indexOf(t);for(var r=0;r<e.length;r++)if(o(t,e[r]))return r;return-1}function n(t,e){i(t,0,t.children.length,e,t)}function i(t,e,o,r,n){n||(n=d(null)),n.minX=1/0,n.minY=1/0,n.maxX=-1/0,n.maxY=-1/0;for(var i,s=e;s<o;s++)i=t.children[s],a(n,t.leaf?r(i):i);return n}function a(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function s(t,e){return t.minX-e.minX}function c(t,e){return t.minY-e.minY}function h(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function u(t){return t.maxX-t.minX+(t.maxY-t.minY)}function l(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function f(t,e){var o=Math.max(t.minX,e.minX),r=Math.max(t.minY,e.minY),n=Math.min(t.maxX,e.maxX),i=Math.min(t.maxY,e.maxY);return Math.max(0,n-o)*Math.max(0,i-r)}function p(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function m(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function d(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function y(t,e,o,r,n){for(var i,a=[e,o];a.length;)o=a.pop(),e=a.pop(),o-e<=r||(i=e+Math.ceil((o-e)/r/2)*r,J(t,i,e,o,n),a.push(e,i,i,o))}function g(t,e,o){if(null!==t){var r,n,i,a,s,c,h,u,l,f,p=0,m=0,d=t.type,y="FeatureCollection"===d,v="Feature"===d,_=y?t.features.length:1;for(r=0;r<_;r++)for(l=y?t.features[r].geometry:v?t.geometry:t,f=!!l&&"GeometryCollection"===l.type,h=f?l.geometries.length:1,n=0;n<h;n++){var x=0;if(null!==(c=f?l.geometries[n]:l)){u=c.coordinates;var b=c.type;switch(p=!o||"Polygon"!==b&&"MultiPolygon"!==b?0:1,b){case null:break;case"Point":e(u,m,r,x),m++,x++;break;case"LineString":case"MultiPoint":for(i=0;i<u.length;i++)e(u[i],m,r,x),m++,"MultiPoint"===b&&x++;"LineString"===b&&x++;break;case"Polygon":case"MultiLineString":for(i=0;i<u.length;i++){for(a=0;a<u[i].length-p;a++)e(u[i][a],m,r,x),m++;"MultiLineString"===b&&x++}"Polygon"===b&&x++;break;case"MultiPolygon":for(i=0;i<u.length;i++){for(a=0;a<u[i].length;a++)for(s=0;s<u[i][a].length-p;s++)e(u[i][a][s],m,r,x),m++;x++}break;case"GeometryCollection":for(i=0;i<c.geometries.length;i++)g(c.geometries[i],e,o);break;default:throw new Error("Unknown Geometry Type")}}}}}function v(t,e,o,r){var n=o;return g(t,function(t,r,i,a){n=0===r&&void 0===o?t:e(n,t,r,i,a)},r),n}function _(t,e){var o;switch(t.type){case"FeatureCollection":for(o=0;o<t.features.length;o++)e(t.features[o].properties,o);break;case"Feature":e(t.properties,0)}}function x(t,e,o){var r=o;return _(t,function(t,n){r=0===n&&void 0===o?t:e(r,t,n)}),r}function b(t,e){if("Feature"===t.type)e(t,0);else if("FeatureCollection"===t.type)for(var o=0;o<t.features.length;o++)e(t.features[o],o)}function M(t,e,o){var r=o;return b(t,function(t,n){r=0===n&&void 0===o?t:e(r,t,n)}),r}function P(t){var e=[];return g(t,function(t){e.push(t)}),e}function w(t,e){var o,r,n,i,a,s,c,h,u=0,l="FeatureCollection"===t.type,f="Feature"===t.type,p=l?t.features.length:1;for(o=0;o<p;o++){for(s=l?t.features[o].geometry:f?t.geometry:t,h=l?t.features[o].properties:f?t.properties:{},c=!!s&&"GeometryCollection"===s.type,a=c?s.geometries.length:1,n=0;n<a;n++)if(null!==(i=c?s.geometries[n]:s))switch(i.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":e(i,u,h);break;case"GeometryCollection":for(r=0;r<i.geometries.length;r++)e(i.geometries[r],u,h);break;default:throw new Error("Unknown Geometry Type")}else e(null,u,h);u++}}function E(t,e,o){var r=o;return w(t,function(t,n,i){r=0===n&&void 0===o?t:e(r,t,n,i)}),r}function G(t,e){w(t,function(t,o,r){var n=null===t?null:t.type;switch(n){case null:case"Point":case"LineString":case"Polygon":return void e(X(t,r),o,0)}var i;switch(n){case"MultiPoint":i="Point";break;case"MultiLineString":i="LineString";break;case"MultiPolygon":i="Polygon"}t.coordinates.forEach(function(t,n){e(X({type:i,coordinates:t},r),o,n)})})}function k(t,e,o){var r=o;return G(t,function(t,n,i){r=0===n&&0===i&&void 0===o?t:e(r,t,n,i)}),r}function B(t,e){G(t,function(t,o,r){var n=0;if(t.geometry){var i=t.geometry.type;"Point"!==i&&"MultiPoint"!==i&&v(t,function(i,a){var s=Y([i,a],t.properties);return e(s,o,r,n),n++,a})}})}function C(t,e,o){var r=o,n=!1;return B(t,function(t,i,a,s){r=!1===n&&void 0===o?t:e(r,t,i,a,s),n=!0}),r}function X(t,e){if(void 0===t)throw new Error("No geometry passed");return{type:"Feature",properties:e||{},geometry:t}}function Y(t,e){if(!t)throw new Error("No coordinates passed");if(t.length<2)throw new Error("Coordinates must be an array of two or more positions");return{type:"Feature",properties:e||{},geometry:{type:"LineString",coordinates:t}}}function L(t,e){if(!t)throw new Error("geojson is required");var o=t.geometry?t.geometry.type:t.type;if(!o)throw new Error("invalid geojson");if("FeatureCollection"===o)throw new Error("FeatureCollection is not supported");if("GeometryCollection"===o)throw new Error("GeometryCollection is not supported");var r=t.geometry?t.geometry.coordinates:t.coordinates;if(!r)throw new Error("geojson must contain coordinates");switch(o){case"LineString":return void e(r,0,0);case"Polygon":case"MultiLineString":for(var n=0,i=0;i<r.length;i++)"MultiLineString"===o&&(n=i),e(r[i],i,n);return;case"MultiPolygon":for(var a=0;a<r.length;a++)for(var s=0;s<r[a].length;s++)e(r[a][s],s,a);return;default:throw new Error(o+" geometry not supported")}}function S(t,e,o){var r=o;return L(t,function(t,n,i){r=0===n&&void 0===o?t:e(r,t,n,i)}),r}function O(t){var e=[t[0],t[1]],o=[t[0],t[3]],r=[t[2],t[3]];return{type:"Feature",bbox:t,properties:{},geometry:{type:"Polygon",coordinates:[[e,[t[2],t[1]],r,o,e]]}}}function T(t){var e=[1/0,1/0,-1/0,-1/0];return H(t,function(t){e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1])}),e}function j(t,e){for(var o=Object.getOwnPropertyNames(e),r=0;r<o.length;r++){var n=o[r],i=Object.getOwnPropertyDescriptor(e,n);i&&i.configurable&&void 0===t[n]&&Object.defineProperty(t,n,i)}return t}function A(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function F(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function N(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):j(t,e))}var R=("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self,function(t,e){return e={exports:{}},t(e,e.exports),e.exports}(function(t,e){!function(e,o){t.exports=function(){function t(t,o,n,i,a){e(t,o,n||0,i||t.length-1,a||r)}function e(t,r,n,i,a){for(;i>n;){if(i-n>600){var s=i-n+1,c=r-n+1,h=Math.log(s),u=.5*Math.exp(2*h/3),l=.5*Math.sqrt(h*u*(s-u)/s)*(c-s/2<0?-1:1);e(t,r,Math.max(n,Math.floor(r-c*u/s+l)),Math.min(i,Math.floor(r+(s-c)*u/s+l)),a)}var f=t[r],p=n,m=i;for(o(t,n,r),a(t[i],f)>0&&o(t,n,i);p<m;){for(o(t,p,m),p++,m--;a(t[p],f)<0;)p++;for(;a(t[m],f)>0;)m--}0===a(t[n],f)?o(t,n,m):(m++,o(t,m,i)),m<=r&&(n=m+1),r<=m&&(i=m-1)}}function o(t,e,o){var r=t[e];t[e]=t[o],t[o]=r}function r(t,e){return t<e?-1:t>e?1:0}return t}()}()})),q=o,D=o,J=R;o.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,o=[],r=this.toBBox;if(!m(t,e))return o;for(var n,i,a,s,c=[];e;){for(n=0,i=e.children.length;n<i;n++)a=e.children[n],s=e.leaf?r(a):a,m(t,s)&&(e.leaf?o.push(a):p(t,s)?this._all(a,o):c.push(a));e=c.pop()}return o},collides:function(t){var e=this.data,o=this.toBBox;if(!m(t,e))return!1;for(var r,n,i,a,s=[];e;){for(r=0,n=e.children.length;r<n;r++)if(i=e.children[r],a=e.leaf?o(i):i,m(t,a)){if(e.leaf||p(t,a))return!0;s.push(i)}e=s.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,o=t.length;e<o;e++)this.insert(t[e]);return this}var r=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var n=this.data;this.data=r,r=n}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=d([]),this},remove:function(t,e){if(!t)return this;for(var o,n,i,a,s=this.data,c=this.toBBox(t),h=[],u=[];s||h.length;){if(s||(s=h.pop(),n=h[h.length-1],o=u.pop(),a=!0),s.leaf&&-1!==(i=r(t,s.children,e)))return s.children.splice(i,1),h.push(s),this._condense(h),this;a||s.leaf||!p(s,c)?n?(o++,s=n.children[o],a=!1):s=null:(h.push(s),u.push(o),o=0,n=s,s=s.children[0])}return this},toBBox:function(t){return t},compareMinX:s,compareMinY:c,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var o=[];t;)t.leaf?e.push.apply(e,t.children):o.push.apply(o,t.children),t=o.pop();return e},_build:function(t,e,o,r){var i,a=o-e+1,s=this._maxEntries;if(a<=s)return i=d(t.slice(e,o+1)),n(i,this.toBBox),i;r||(r=Math.ceil(Math.log(a)/Math.log(s)),s=Math.ceil(a/Math.pow(s,r-1))),i=d([]),i.leaf=!1,i.height=r;var c,h,u,l,f=Math.ceil(a/s),p=f*Math.ceil(Math.sqrt(s));for(y(t,e,o,p,this.compareMinX),c=e;c<=o;c+=p)for(u=Math.min(c+p-1,o),y(t,c,u,f,this.compareMinY),h=c;h<=u;h+=f)l=Math.min(h+f-1,u),i.children.push(this._build(t,h,l,r-1));return n(i,this.toBBox),i},_chooseSubtree:function(t,e,o,r){for(var n,i,a,s,c,u,f,p;;){if(r.push(e),e.leaf||r.length-1===o)break;for(f=p=1/0,n=0,i=e.children.length;n<i;n++)a=e.children[n],c=h(a),u=l(t,a)-c,u<p?(p=u,f=c<f?c:f,s=a):u===p&&c<f&&(f=c,s=a);e=s||e.children[0]}return e},_insert:function(t,e,o){var r=this.toBBox,n=o?t:r(t),i=[],s=this._chooseSubtree(n,this.data,e,i);for(s.children.push(t),a(s,n);e>=0&&i[e].children.length>this._maxEntries;)this._split(i,e),e--;this._adjustParentBBoxes(n,i,e)},_split:function(t,e){var o=t[e],r=o.children.length,i=this._minEntries;this._chooseSplitAxis(o,i,r);var a=this._chooseSplitIndex(o,i,r),s=d(o.children.splice(a,o.children.length-a));s.height=o.height,s.leaf=o.leaf,n(o,this.toBBox),n(s,this.toBBox),e?t[e-1].children.push(s):this._splitRoot(o,s)},_splitRoot:function(t,e){this.data=d([t,e]),this.data.height=t.height+1,this.data.leaf=!1,n(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,o){var r,n,a,s,c,u,l,p;for(u=l=1/0,r=e;r<=o-e;r++)n=i(t,0,r,this.toBBox),a=i(t,r,o,this.toBBox),s=f(n,a),c=h(n)+h(a),s<u?(u=s,p=r,l=c<l?c:l):s===u&&c<l&&(l=c,p=r);return p},_chooseSplitAxis:function(t,e,o){var r=t.leaf?this.compareMinX:s,n=t.leaf?this.compareMinY:c;this._allDistMargin(t,e,o,r)<this._allDistMargin(t,e,o,n)&&t.children.sort(r)},_allDistMargin:function(t,e,o,r){t.children.sort(r);var n,s,c=this.toBBox,h=i(t,0,e,c),l=i(t,o-e,o,c),f=u(h)+u(l);for(n=e;n<o-e;n++)s=t.children[n],a(h,t.leaf?c(s):s),f+=u(h);for(n=o-e-1;n>=e;n--)s=t.children[n],a(l,t.leaf?c(s):s),f+=u(l);return f},_adjustParentBBoxes:function(t,e,o){for(var r=o;r>=0;r--)a(e[r],t)},_condense:function(t){for(var e,o=t.length-1;o>=0;o--)0===t[o].children.length?o>0?(e=t[o-1].children,e.splice(e.indexOf(t[o]),1)):this.clear():n(t[o],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}},q.default=D;var I=Object.freeze({coordEach:g,coordReduce:v,propEach:_,propReduce:x,featureEach:b,featureReduce:M,coordAll:P,geomEach:w,geomReduce:E,flattenEach:G,flattenReduce:k,segmentEach:B,segmentReduce:C,feature:X,lineString:Y,lineEach:L,lineReduce:S}),V=I&&void 0||I,U=q,W=V,z=W.featureEach,H=W.coordEach,Z=function(t){var e=U(t);return e.insert=function(t){if(Array.isArray(t)){var e=t;t=O(e),t.bbox=e}else t.bbox=t.bbox?t.bbox:T(t);return U.prototype.insert.call(this,t)},e.load=function(t){var e=[];return Array.isArray(t)?t.forEach(function(t){var o=O(t);o.bbox=t,e.push(o)}):z(t,function(t){t.bbox=t.bbox?t.bbox:T(t),e.push(t)}),U.prototype.load.call(this,e)},e.remove=function(t){if(Array.isArray(t)){var e=t;t=O(e),t.bbox=e}return U.prototype.remove.call(this,t)},e.clear=function(){return U.prototype.clear.call(this)},e.search=function(t){return{type:"FeatureCollection",features:U.prototype.search.call(this,this.toBBox(t))}},e.collides=function(t){return U.prototype.collides.call(this,this.toBBox(t))},e.all=function(){return{type:"FeatureCollection",features:U.prototype.all.call(this)}},e.toJSON=function(){return U.prototype.toJSON.call(this)},e.fromJSON=function(t){return U.prototype.fromJSON.call(this,t)},e.toBBox=function(t){var e;return e=t.bbox?t.bbox:Array.isArray(t)&&4===t.length?t:T(t),{minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]}},e},K={mode:"line",tolerance:10,symbol:{markerType:"ellipse",markerFill:"#0f89f5",markerLineColor:"#fff",markerLineWidth:2,markerLineOpacity:1,markerWidth:15,markerHeight:15}},Q=function(t){function o(e){A(this,o);var r=F(this,t.call(this,e));return r.tree=Z(),r}return N(o,t),o.prototype.getMode=function(){if(this._mode=this._mode?this._mode:this.options.mode,this._checkMode(this._mode))return this._mode;throw new Error("snap mode is invalid")},o.prototype.setMode=function(t){if(!this._checkMode(this._mode))throw new Error("snap mode is invalid");if(this._mode=t,this.snaplayer){var e=this.snaplayer.getGeometries();this.allGeometries=this._compositGeometries(e)}},o.prototype.addTo=function(t){var o=e.INTERNAL_LAYER_PREFIX+"_snapto";this._mousemoveLayer=new e.VectorLayer(o).addTo(t),this._map=t,this.allGeometries=[],this.enable()},o.prototype.remove=function(){this.disable(),this._mousemoveLayer&&(this._mousemoveLayer.remove(),delete this._mousemoveLayer)},o.prototype.getMap=function(){return this._map},o.prototype._checkMode=function(t){return"point"===t||"line"===t},o.prototype.enable=function(){var t=this.getMap();if(this.snaplayer){var e=this.snaplayer.getGeometries();this.allGeometries=this._compositGeometries(e)}if(!this.allGeometries)throw new Error("you should set geometries which are snapped to firstly!");this._mousemove||this._registerEvents(t),this._mousemoveLayer&&this._mousemoveLayer.show()},o.prototype.disable=function(){this.getMap().off("mousemove touchstart",this._mousemove),this._mousemoveLayer&&this._mousemoveLayer.hide(),delete this._mousemove,this.allGeometries=[]},o.prototype.setGeometries=function(t){t=t instanceof Array?t:[t],this.allGeometries=this._compositGeometries(t)},o.prototype.setLayer=function(t){if(t instanceof e.VectorLayer){var o=t.getGeometries();this.snaplayer=t,this.allGeometries=this._compositGeometries(o),t.on("addgeo",function(){var t=this.snaplayer.getGeometries();this.allGeometries=this._compositGeometries(t)},this),this.snaplayer.on("clear",function(){this._clearGeometries()},this),this._mousemoveLayer.bringToFront()}},o.prototype.bindDrawTool=function(t){var o=this;t instanceof e.DrawTool&&(t.on("drawstart",function(t){o.snapPoint&&(o._resetCoordinates(t.target._geometry,o.snapPoint),o._resetClickPoint(t.target._clickCoords,o.snapPoint))},this),t.on("mousemove",function(t){o.snapPoint&&o._resetCoordinates(t.target._geometry,o.snapPoint)},this),t.on("drawvertex",function(t){o.snapPoint&&(o._resetCoordinates(t.target._geometry,o.snapPoint),o._resetClickPoint(t.target._clickCoords,o.snapPoint))},this),t.on("drawend",function(t){if(o.snapPoint){var e=t.geometry;o._resetCoordinates(e,o.snapPoint)}},this))},o.prototype._resetCoordinates=function(t,o){var r=t.getCoordinates();if(t instanceof e.Polygon){var n=r[0];n.splice(n.length-2,1)}else r instanceof Array?(r[r.length-1].x=o.x,r[r.length-1].y=o.y):r instanceof e.Coordinate&&(r.x=o.x,r.y=o.y);return t.setCoordinates(r),t},o.prototype._resetClickPoint=function(t,e){t[t.length-1].x=e.x,t[t.length-1].y=e.y},o.prototype._addGeometries=function(t){t=t instanceof Array?t:[t];var e=this._compositGeometries(t);this.allGeometries=this.allGeometries.concat(e)},o.prototype._clearGeometries=function(){this.addGeometries=[]},o.prototype._prepareGeometries=function(t){if(this.allGeometries){var e=this.allGeometries;this.tree.clear(),this.tree.load({type:"FeatureCollection",features:e}),this.inspectExtent=this._createInspectExtent(t);return this.tree.search(this.inspectExtent)}return null},o.prototype._compositGeometries=function(t){var e=[],o=this.getMode();return"point"===o?e=this._compositToPoints(t):"line"===o&&(e=this._compositToLines(t)),e},o.prototype._compositToPoints=function(t){var e=[];return t.forEach(function(t){e=e.concat(this._parserToPoints(t))}.bind(this)),e},o.prototype._createMarkers=function(t){var o=[];return t.forEach(function(t){var r=new e.Marker(t,{properties:{}});r=r.toGeoJSON(),o.push(r)}),o},o.prototype._parserToPoints=function(t){var e=t.getType(),o=null;o="Circle"===e||"Ellipse"===e?t.getShell():t.getCoordinates();var r=[];if(o[0]instanceof Array)o.forEach(function(t){var e=this._createMarkers(t);r=r.concat(e)}.bind(this));else{o instanceof Array||(o=[o]);var n=this._createMarkers(o);r=r.concat(n)}return r},o.prototype._compositToLines=function(t){var e=[];return t.forEach(function(t){switch(t.getType()){case"Point":var o=t.toGeoJSON();o.properties={},e.push(o);break;case"LineString":case"Polygon":e=e.concat(this._parserGeometries(t,1))}}.bind(this)),e},o.prototype._parserGeometries=function(t,e){var o=t.getCoordinates(),r=[];if(o[0]instanceof Array)o.forEach(function(o){var n=this._createLine(o,e,t);r=r.concat(n)}.bind(this));else{var n=this._createLine(o,e,t);r=r.concat(n)}return r},o.prototype._createLine=function(t,o,r){for(var n=[],i=t.length-o,a=0;a<i;a++){var s=new e.LineString([t[a],t[a+1]],{properties:{obj:r}});n.push(s.toGeoJSON())}return n},o.prototype._createInspectExtent=function(t){var o=this.options.tolerance?this.options.tolerance:10,r=this.getMap(),n=r.getZoom(),i=r.coordinateToPoint(t,n),a=r.pointToCoordinate(new e.Point([i.x-o,i.y-o]),n),s=r.pointToCoordinate(new e.Point([i.x+o,i.y-o]),n),c=r.pointToCoordinate(new e.Point([i.x-o,i.y+o]),n),h=r.pointToCoordinate(new e.Point([i.x+o,i.y+o]),n);return{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[[a.x,a.y],[s.x,s.y],[h.x,h.y],[c.x,c.y]]]}}},o.prototype._registerEvents=function(t){this._mousemove=function(t){this.mousePoint=t.coordinate,this._marker?this._marker.setCoordinates(t.coordinate):this._marker=new e.Marker(t.coordinate,{symbol:this.options.symbol}).addTo(this._mousemoveLayer);var o=this._findGeometry(t.coordinate);o.features.length>0?(this.snapPoint=this._getSnapPoint(o),this.snapPoint&&this._marker.setCoordinates([this.snapPoint.x,this.snapPoint.y])):this.snapPoint=null},t.on("mousemove touchstart",this._mousemove,this)},o.prototype._setDistance=function(t){for(var e=[],o=0;o<t.length;o++){var r=t[o];if("LineString"===r.geometry.type){var n=this._distToPolyline(this.mousePoint,r);e.push({geoObject:r,distance:n})}else if("Point"===r.geometry.type){var i=this._distToPoint(this.mousePoint,r);e.push({geoObject:r,distance:i})}}return e},o.prototype._findNearestGeometries=function(t){var e=this._setDistance(t);return e=e.sort(this._compare(e,"distance")),e[0]},o.prototype._findGeometry=function(t){return this._prepareGeometries(t)},o.prototype._getSnapPoint=function(t){var e=this._findNearestGeometries(t.features),o=null;if(!this._validDistance(e.distance))return null;if("Point"===e.geoObject.geometry.type)o={x:e.geoObject.geometry.coordinates[0],y:e.geoObject.geometry.coordinates[1]};else if("LineString"===e.geoObject.geometry.type){var r=this._setEquation(e.geoObject);if(0===r.A)o={x:this.mousePoint.x,y:e.geoObject.geometry.coordinates[0][1]};else if(r.A===1/0)o={x:e.geoObject.geometry.coordinates[0][0],y:this.mousePoint.y};else{var n=r.B/r.A,i=this._setVertiEquation(n,this.mousePoint);o=this._solveEquation(r,i)}}return o},o.prototype._distToPolyline=function(t,e){var o=this._setEquation(e),r=o.A,n=o.B,i=o.C;return Math.abs((r*t.x+n*t.y+i)/Math.sqrt(Math.pow(r,2)+Math.pow(n,2)))},o.prototype._validDistance=function(t){return!(t/this.getMap().getResolution()>this.options.tolerance)},o.prototype._distToPoint=function(t,e){var o=[t.x,t.y],r=e.geometry.coordinates;return Math.sqrt(Math.pow(o[0]-r[0],2)+Math.pow(o[1]-r[1],2))},o.prototype._setEquation=function(t){var e=t.geometry.coordinates,o=e[0],r=e[1],n=Number((o[1]-r[1])/(o[0]-r[0]).toString());return{A:n,B:-1,C:o[1]-n*o[0]}},o.prototype._setVertiEquation=function(t,e){return{A:t,B:-1,C:e.y-t*e.x}},o.prototype._solveEquation=function(t,e){var o=t.A,r=t.B,n=t.C,i=e.A,a=e.B,s=e.C;return{x:(r*s-n*a)/(o*a-i*r),y:(o*s-i*n)/(r*i-a*o)}},o.prototype._compare=function(t,e){return function(t,o){var r=t[e],n=o[e];return n<r?1:n>r?-1:0}},o}(e.Class);Q.mergeOptions(K),t.SnapTool=Q,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.snapto v0.1.9, requires maptalks@^0.33.1.")});